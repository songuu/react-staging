import{red as e,cyan as t,bold as n,green as i,grey as s}from"kleur/colors";import o from"prompts";import*as c from"node:fs";import a,{readFileSync as r}from"node:fs";import*as l from"node:path";import{join as p}from"node:path";import{execSync as m,exec as u}from"child_process";import f from"version-compare";import y from"path";import{fileURLToPath as d}from"url";import g from"ejs";import v from"minimist";import{pathToFileURL as S}from"node:url";import h from"@songyulala/create-eslint-config";import j from"ora";import w from"fs-extra";import k from"tar";import b from"axios";const x=d(import.meta.url),$=y.dirname(x),F=a.realpathSync(process.cwd());function T(e){return y.resolve(F,e)}const N=()=>{try{return m("pnpm --version",{stdio:"ignore"}),"pnpm"}catch(e){try{return m("yarn --version",{stdio:"ignore"}),"yarn"}catch(e){return"npm"}}};async function O(){const{version:e,name:t}=function(){const e=l.join($,"../../../package.json"),t=JSON.parse(c.readFileSync(e,"utf-8"));return{version:t.version||"",name:t.name||""}}(),n=function(e){try{return{version:m(`npm show ${e} version`).toString().trim(),forceUpdate:"true"===m(`npm show ${e} forceUpdate`).toString().trim()}}catch(e){return console.error("Error fetching the latest version from npm:",e),null}}(t);if(!n)return void console.log("无法获取最新版本信息");const{version:i,forceUpdate:s}=n;if(function(e,t){return f(e,t)<=0}(e,i)){console.log(`当前版本 ${e} 已过期，请更新到最新版本 ${i}。这是强制更新，更新后才能继续使用。`);let n;switch(N()){case"yarn":n="yarn global add";break;case"pnpm":n="pnpm add -g";break;default:n="npm install -g"}try{m(`${n} ${t}`,{stdio:"inherit"}),console.log("脚手架已成功更新到最新版本。")}catch(e){console.error("更新失败:",e)}}else console.log("当前版本已是最新版本。")}const J="1.0.0",U={active:"yes",inactive:"no"};function P(e,t,n){for(const i of c.readdirSync(e)){if(".git"===i)continue;const s=l.resolve(e,i);c.lstatSync(s).isDirectory()?(t(s),c.existsSync(s)&&P(s,t,n)):n(s)}}function _(e,t,n){for(const i of c.readdirSync(e)){if(".git"===i)continue;const s=l.resolve(e,i);c.lstatSync(s).isDirectory()?(_(s,t,n),t(s)):n(s)}}function D(e){c.existsSync(e)&&_(e,(e=>c.rmdirSync(e)),(e=>c.unlinkSync(e)))}function z(e){const t={},n=["dependencies","devDependencies","peerDependencies","optionalDependencies"];for(const i of n)e[i]&&(t[i]={},Object.keys(e[i]).sort().forEach((n=>{t[i][n]=e[i][n]})));return{...e,...t}}const E=e=>e&&"object"==typeof e,A=(e,t)=>Array.from(new Set([...e,...t]));function W(e,t){for(const n of Object.keys(t)){const i=e[n],s=t[n];Array.isArray(i)&&Array.isArray(s)?e[n]=A(i,s):E(i)&&E(s)?e[n]=W(i,s):e[n]=s}return e}function H(e,t,n,i){if(c.statSync(e).isDirectory()){if("node_modules"===l.basename(e))return;c.mkdirSync(t,{recursive:!0});for(const s of c.readdirSync(e))H(l.resolve(e,s),l.resolve(t,s),n,i);return}const s=l.basename(e);if("package.json"===s&&c.existsSync(t)){const n=z(W(JSON.parse(c.readFileSync(t,"utf8")),JSON.parse(c.readFileSync(e,"utf8"))));c.writeFileSync(t,JSON.stringify(n,null,2)+"\n")}else if(s.startsWith("_")&&(t=l.resolve(l.dirname(t),s.replace(/^_/,"."))),"_gitignore"===s&&c.existsSync(t)){const n=c.readFileSync(t,"utf8"),i=c.readFileSync(e,"utf8");c.writeFileSync(t,n+"\n"+i)}else{if(s.endsWith(".data.mjs"))return t=t.replace(/\.data\.mjs$/,""),void n.push((async n=>{const s=(await import(S(e).toString())).default;n[t]=await s({oldData:n[t]||{},deps:JSON.parse(i)})}));c.copyFileSync(e,t)}}function L(e,t,n){return"install"===t?"yarn"===e?"yarn":`${e} install`:"npm"===e?`npm run ${t}`:`${e} ${t}`}async function V(){const s=process.cwd(),a=v(process.argv.slice(2),{alias:{force:"f",help:"h",version:"v",ts:"typescript",eslint:"e",prettier:"p",husky:"h","lint-staged":"ls","unit-testing":"ut",jest:"j",vitest:"v"},string:["_"],boolean:!0});let r=a._[0];const p=r||"new-project",m=a.force||a.f,u="boolean"==typeof(a.ts||a.typescript||a.eslint||a.prettier||a.husky||a["lint-staged"]||a["unit-testing"]||a.jest||a.vitest);let f={};try{f=await o([{name:"projectName",type:r?null:"text",message:"Project name:",initial:p,onState:e=>r=String(e.value).trim()||p},{name:"needsTypeScript",type:()=>u?null:"toggle",message:"Use TypeScript?",initial:U.inactive,active:U.active,inactive:U.inactive},{name:"needsEslint",type:()=>u?null:"toggle",message:"Use ESLint?",initial:U.inactive,active:U.active,inactive:U.inactive},{name:"needsPrettier",type:()=>u?null:"toggle",message:"Use Prettier?",initial:U.inactive,active:U.active,inactive:U.inactive},{name:"needsHusky",message:"Use Husky?",type:()=>u?null:"toggle",initial:U.inactive,active:U.active,inactive:U.inactive},{name:"needsLintStaged",type:()=>u?null:"toggle",message:"Use lint-staged?",initial:U.inactive,active:U.active,inactive:U.inactive},{name:"needsUnitTesting",type:()=>u?null:"select",message:"Use unit testing?",hint:"choose a testing framework",initial:0,choices:()=>[{title:"No",value:!1},{title:"Jest",value:"Jest"},{title:"Vitest",value:"Vitest"}]},{name:"managementTool",type:()=>u?null:"select",message:"Use management tool?recommend pnpm.",hint:"choose a management tool",initial:0,choices:()=>[{title:"pnpm",value:"pnpm"},{title:"yarn",value:"yarn"},{title:"npm",value:"npm"}]},{name:"buildTool",type:()=>u?null:"select",message:"Use build tool?recommend vite.",hint:"choose a build tool",initial:0,choices:()=>[{title:"vite",value:"vite"},{title:"webpack",value:"webpack"},{title:"rollup",value:"rollup"}]},{name:"atomizationcss",type:()=>u?null:"select",message:"Use atomization css?",hint:"choose a atomization css",initial:0,choices:()=>[{title:"No",value:!1},{title:"tailwindcss",value:"tailwindcss"},{title:"windicss",value:"windicss"},{title:"unocss",value:"unocss"}]}])}catch(t){console.log(e("\nOperation cancelled.")),process.exit(1)}const y=f.projectName||p,d=a.ts||a.typescript||f.needsTypeScript,S=a.eslint||f.needsEslint,j=a.prettier||f.needsPrettier;a.husky||f.needsHusky,a["lint-staged"]||f.needsLintStaged;const w=a["unit-testing"]||f.needsUnitTesting,k=a.jest||f.needsJest,b=a.vitest||f.needsVitest,x=f.managementTool||"pnpm",F=f.buildTool||"vite",T=f.atomizationcss||!1,N=l.join(s,r);m&&c.existsSync(N)?D(N):c.existsSync(N)||c.mkdirSync(N);const O={name:y,version:J};c.writeFileSync(l.resolve(N,"package.json"),JSON.stringify(O,null,2));const _=l.resolve($,"templates"),E=[],A=function(e){H(l.resolve(_,e),N,E,JSON.stringify(f))};if(A("base"),d){A("config/typescript"),A("tsconfig/base");const e={files:[],references:[{path:"./tsconfig.node.json"},{path:"./tsconfig.app.json"}]};k&&(A("tsconfig/jest"),e.references.push({path:"./tsconfig.jest.json"})),b&&(A("tsconfig/vitest"),e.references.push({path:"./tsconfig.vitest.json"})),c.writeFileSync(l.resolve(N,"tsconfig.json"),JSON.stringify(e,null,2)+"\n","utf-8")}if(S&&function(e,{needsTypeScript:t,needsPrettier:n}){const{pkg:i,files:s}=h({styleGuide:"default",hasTypeScript:t,needsPrettier:n,additionalConfig:{},additionalDependencies:{}}),o={lint:t?"eslint . --ext .js,.jsx,.cjs,.mjs,.ts,.tsx,.cts,.mts --fix --ignore-path .gitignore":"eslint . --ext .js,.jsx,.cjs,.mjs --fix --ignore-path .gitignore"};n&&(o.format="prettier --write src/");const a=l.resolve(e,"package.json"),r=z(W(W(JSON.parse(c.readFileSync(a,"utf8")),i),{scripts:o}));c.writeFileSync(a,JSON.stringify(r,null,2)+"\n","utf-8");for(const[t,n]of Object.entries(s)){const i=l.resolve(e,t);c.writeFileSync(i,n,"utf-8")}}(N,{needsTypeScript:d,needsPrettier:j}),w&&(k?A("config/jest"):b&&A("config/vitest")),T)switch(T){case"tailwindcss":A("config/tailwindcss"),A("entry/tailwindcss");break;case"windicss":A("config/windicss"),A("windicss/base");break;case"unocss":A("config/unocss"),A("unocss")}switch(A("entry/default"),A("code/router"),F){case"vite":A("config/vite"),A("vite");break;case"webpack":A("config/webpack"),A("webpack/base");break;case"rollup":A("config/rollup"),A("rollup")}const V={};for(const e of E)await e(V);if(P(N,(()=>{}),(e=>{if(e.endsWith(".ejs")){const t=c.readFileSync(e,"utf-8"),n=e.replace(/\.ejs$/,"");let i="";i=n.includes("html")?g.render(t,{title:y,buildTool:F,needsTypeScript:d}):g.render(t,V[n]),c.writeFileSync(n,i),c.unlinkSync(e)}})),d){P(N,(e=>{}),(e=>{if(e.endsWith(".js")){const t=e.replace(/\.js$/,".ts");c.existsSync(t)?c.unlinkSync(e):c.renameSync(e,t)}else"jsconfig.json"===l.basename(e)&&c.unlinkSync(e)}));const e=l.resolve(N,"index.html"),t=c.readFileSync(e,"utf8");c.writeFileSync(e,t.replace("src/main.js","src/main.ts"))}else P(N,(()=>{}),(e=>{e.endsWith(".ts")&&c.unlinkSync(e)}));s!==N&&console.log(t("cd"),l.relative(s,N)),console.log(n(i(L(x,"install")))),j&&console.log(n(i(L(x,"format")))),console.log(n(i(L(x,"dev")))),console.log()}function C(e){var t;return t=`../template-config/${e}.json`,JSON.parse(r(p($,t)).toString())}async function M(s,o,c,a){const r=j().start();r.start(n(t("Creating a project..."))),b.get(s,{responseType:"arraybuffer"}).then((async t=>{const s=T(c),a=p(s,`${o}-${J}.tgz`);w.writeFileSync(a,t.data),k.extract({file:a,cwd:s,sync:!0}),w.unlinkSync(a),await async function(t,n){try{await w.ensureDir(n),await w.copy(t,n)}catch(t){console.log(e("\n 模板下载过程中可能出现网络错误,请重新尝试")),process.exit(0)}}(p(c,"package/template"),c),await w.readJsonSync(p(c,"package/package.json")),function(e="node_modules",t=!0){if(!0===t){const t=j().start();t.start(n("File being deleted..."));try{w.removeSync(T(`${e}`))}catch(e){console.log(e)}t.succeed(n(i("deleted successfully")))}w.removeSync(T(`${e}`))}(p(c,"package"),!1),r.succeed(n(i("Project creation successfully")))})).catch((e=>{console.error("Error:",e)}))}const G=new Map(function(e){const t=new Map;return e.forEach((e=>{t.set(e,`https://registry.npmjs.org/@songyulala/template-${e}/-/template-${e}-2.0.0.tgz`)})),t}(["react-vite","react-webpack"]));(async function(){console.log(`${s("create-stage")}`),O();const{template:a}=await o({type:"select",name:"template",message:"请选择模板",choices:[{title:"完整模板",value:"full"},{title:"自定义模板",value:"custom"}]});"full"===a?(console.log("full"),async function(){const s=process.cwd(),a=v(process.argv.slice(2),{alias:{force:"f"},string:["_"],boolean:!0});let r=a._[0];const p=r||"new-project",m=a.force||a.f;let f={};try{f=await o([{name:"projectName",type:r?null:"text",message:"Project name:",initial:p,onState:e=>r=String(e.value).trim()||p},{name:"projectType",type:"select",message:"Select features:",hint:"choose the template you want to use",initial:0,choices:[{title:"react-vite",value:"react-vite"},{title:"react-webpack",value:"react-webpack"}]},{name:"managementTool",type:"select",message:"Use management tool?recommend pnpm.",hint:"choose a management tool",initial:0,choices:()=>[{title:"pnpm",value:"pnpm"},{title:"yarn",value:"yarn"},{title:"npm",value:"npm"}]}])}catch(t){console.log(e("\nOperation cancelled.")),process.exit(1)}const y=f.projectName||p,d=f.projectType||"react-vite",g=f.managementTool||"pnpm",S=l.join(s,r);m&&c.existsSync(S)?D(S):c.existsSync(S)||c.mkdirSync(S);const h=C(d),w={name:y,version:J,...h},k=l.resolve(S,"package.json");await c.writeFileSync(k,JSON.stringify(w,null,2)+"\n","utf-8"),await M(G.get(d),d,S);const b=j().start();b.start(n(t("The dependency package is being installed..."))),s!==S&&(console.log(t("cd"),l.relative(s,S)),u("cd "+l.relative(s,S),((e,t,n)=>{e&&console.error(e)}))),u(`${g} install`,{cwd:S},((e,t,s)=>{e?console.error(e):(b.succeed(n(i("🚀 Project initialization is complete"))),console.log(t))}))}().catch((e=>{console.error(e)}))):(console.log("custom"),V().catch((e=>{console.error(e)})))})().catch((e=>{console.error(e)}));
