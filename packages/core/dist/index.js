import{red as e,cyan as t,bold as n,green as i,grey as s}from"kleur/colors";import o from"prompts";import*as c from"node:fs";import a from"node:fs";import*as r from"node:path";import{join as l}from"node:path";import p from"ejs";import m from"minimist";import{pathToFileURL as u}from"node:url";import f from"@songyulala/create-eslint-config";import y from"path";import{fileURLToPath as d}from"url";import{exec as g}from"child_process";import v from"ora";import S from"fs-extra";import h from"tar";import j from"axios";const w="1.0.0",k={active:"yes",inactive:"no"};function b(e,t,n){for(const i of c.readdirSync(e)){if(".git"===i)continue;const s=r.resolve(e,i);c.lstatSync(s).isDirectory()?(t(s),c.existsSync(s)&&b(s,t,n)):n(s)}}function x(e,t,n){for(const i of c.readdirSync(e)){if(".git"===i)continue;const s=r.resolve(e,i);c.lstatSync(s).isDirectory()?(x(s,t,n),t(s)):n(s)}}function T(e){c.existsSync(e)&&x(e,(e=>c.rmdirSync(e)),(e=>c.unlinkSync(e)))}function $(e){const t={},n=["dependencies","devDependencies","peerDependencies","optionalDependencies"];for(const i of n)e[i]&&(t[i]={},Object.keys(e[i]).sort().forEach((n=>{t[i][n]=e[i][n]})));return{...e,...t}}const F=e=>e&&"object"==typeof e,N=(e,t)=>Array.from(new Set([...e,...t]));function O(e,t){for(const n of Object.keys(t)){const i=e[n],s=t[n];Array.isArray(i)&&Array.isArray(s)?e[n]=N(i,s):F(i)&&F(s)?e[n]=O(i,s):e[n]=s}return e}function J(e,t,n,i){if(c.statSync(e).isDirectory()){if("node_modules"===r.basename(e))return;c.mkdirSync(t,{recursive:!0});for(const s of c.readdirSync(e))J(r.resolve(e,s),r.resolve(t,s),n,i);return}const s=r.basename(e);if("package.json"===s&&c.existsSync(t)){const n=$(O(JSON.parse(c.readFileSync(t,"utf8")),JSON.parse(c.readFileSync(e,"utf8"))));c.writeFileSync(t,JSON.stringify(n,null,2)+"\n")}else if(s.startsWith("_")&&(t=r.resolve(r.dirname(t),s.replace(/^_/,"."))),"_gitignore"===s&&c.existsSync(t)){const n=c.readFileSync(t,"utf8"),i=c.readFileSync(e,"utf8");c.writeFileSync(t,n+"\n"+i)}else{if(s.endsWith(".data.mjs"))return t=t.replace(/\.data\.mjs$/,""),void n.push((async n=>{const s=(await import(u(e).toString())).default;n[t]=await s({oldData:n[t]||{},deps:JSON.parse(i)})}));c.copyFileSync(e,t)}}const U=d(import.meta.url),P=y.dirname(U),_=a.realpathSync(process.cwd());function D(e){return y.resolve(_,e)}function z(e,t,n){return"install"===t?"yarn"===e?"yarn":`${e} install`:n?"npm"===e?`npm run ${t} -- ${n}`:`${e} ${t} ${n}`:"npm"===e?`npm run ${t}`:`${e} ${t}`}async function E(){const s=process.cwd(),a=m(process.argv.slice(2),{alias:{force:"f",help:"h",version:"v",ts:"typescript",eslint:"e",prettier:"p",husky:"h","lint-staged":"ls","unit-testing":"ut",jest:"j",vitest:"v"},string:["_"],boolean:!0});let l=a._[0];const u=l||"new-project",y=a.force||a.f,d="boolean"==typeof(a.ts||a.typescript||a.eslint||a.prettier||a.husky||a["lint-staged"]||a["unit-testing"]||a.jest||a.vitest);let g={};try{g=await o([{name:"projectName",type:l?null:"text",message:"Project name:",initial:u,onState:e=>l=String(e.value).trim()||u},{name:"needsTypeScript",type:()=>d?null:"toggle",message:"Use TypeScript?",initial:k.inactive,active:k.active,inactive:k.inactive},{name:"needsEslint",type:()=>d?null:"toggle",message:"Use ESLint?",initial:k.inactive,active:k.active,inactive:k.inactive},{name:"needsPrettier",type:()=>d?null:"toggle",message:"Use Prettier?",initial:k.inactive,active:k.active,inactive:k.inactive},{name:"needsHusky",message:"Use Husky?",type:()=>d?null:"toggle",initial:k.inactive,active:k.active,inactive:k.inactive},{name:"needsLintStaged",type:()=>d?null:"toggle",message:"Use lint-staged?",initial:k.inactive,active:k.active,inactive:k.inactive},{name:"needsUnitTesting",type:()=>d?null:"select",message:"Use unit testing?",hint:"choose a testing framework",initial:0,choices:()=>[{title:"No",value:!1},{title:"Jest",value:"Jest"},{title:"Vitest",value:"Vitest"}]},{name:"managementTool",type:()=>d?null:"select",message:"Use management tool?recommend pnpm.",hint:"choose a management tool",initial:0,choices:()=>[{title:"pnpm",value:"pnpm"},{title:"yarn",value:"yarn"},{title:"npm",value:"npm"}]},{name:"buildTool",type:()=>d?null:"select",message:"Use build tool?recommend vite.",hint:"choose a build tool",initial:0,choices:()=>[{title:"vite",value:"vite"},{title:"webpack",value:"webpack"},{title:"rollup",value:"rollup"}]},{name:"atomizationcss",type:()=>d?null:"select",message:"Use atomization css?",hint:"choose a atomization css",initial:0,choices:()=>[{title:"No",value:!1},{title:"tailwindcss",value:"tailwindcss"},{title:"windicss",value:"windicss"},{title:"unocss",value:"unocss"}]}])}catch(t){console.log(e("\nOperation cancelled.")),process.exit(1)}const v=g.projectName||u,S=a.ts||a.typescript||g.needsTypeScript,h=a.eslint||g.needsEslint,j=a.prettier||g.needsPrettier;a.husky||g.needsHusky,a["lint-staged"]||g.needsLintStaged;const x=a["unit-testing"]||g.needsUnitTesting,F=a.jest||g.needsJest,N=a.vitest||g.needsVitest,U=g.managementTool||"pnpm",_=g.buildTool||"vite",D=g.atomizationcss||!1,E=r.join(s,l);y&&c.existsSync(E)?T(E):c.existsSync(E)||c.mkdirSync(E);const A={name:v,version:w};c.writeFileSync(r.resolve(E,"package.json"),JSON.stringify(A,null,2));const W=r.resolve(P,"templates"),H=[],L=function(e){J(r.resolve(W,e),E,H,JSON.stringify(g))};if(L("base"),S){L("config/typescript"),L("tsconfig/base");const e={files:[],references:[{path:"./tsconfig.node.json"},{path:"./tsconfig.app.json"}]};F&&(L("tsconfig/jest"),e.references.push({path:"./tsconfig.jest.json"})),N&&(L("tsconfig/vitest"),e.references.push({path:"./tsconfig.vitest.json"})),c.writeFileSync(r.resolve(E,"tsconfig.json"),JSON.stringify(e,null,2)+"\n","utf-8")}if(h&&function(e,{needsTypeScript:t,needsPrettier:n}){const{pkg:i,files:s}=f({styleGuide:"default",hasTypeScript:t,needsPrettier:n,additionalConfig:{},additionalDependencies:{}}),o={lint:t?"eslint . --ext .js,.jsx,.cjs,.mjs,.ts,.tsx,.cts,.mts --fix --ignore-path .gitignore":"eslint . --ext .js,.jsx,.cjs,.mjs --fix --ignore-path .gitignore"};n&&(o.format="prettier --write src/");const a=r.resolve(e,"package.json"),l=$(O(O(JSON.parse(c.readFileSync(a,"utf8")),i),{scripts:o}));c.writeFileSync(a,JSON.stringify(l,null,2)+"\n","utf-8");for(const[t,n]of Object.entries(s)){const i=r.resolve(e,t);c.writeFileSync(i,n,"utf-8")}}(E,{needsTypeScript:S,needsPrettier:j}),x&&(F?L("config/jest"):N&&L("config/vitest")),D)switch(D){case"tailwindcss":L("config/tailwindcss"),L("entry/tailwindcss");break;case"windicss":L("config/windicss"),L("windicss/base");break;case"unocss":L("config/unocss"),L("unocss")}switch(L("entry/default"),L("code/router"),_){case"vite":L("config/vite"),L("vite");break;case"webpack":L("config/webpack"),L("webpack/base");break;case"rollup":L("config/rollup"),L("rollup")}const V={};for(const e of H)await e(V);if(b(E,(()=>{}),(e=>{if(e.endsWith(".ejs")){const t=c.readFileSync(e,"utf-8"),n=e.replace(/\.ejs$/,"");let i="";i=n.includes("html")?p.render(t,{title:v,buildTool:_,needsTypeScript:S}):p.render(t,V[n]),c.writeFileSync(n,i),c.unlinkSync(e)}})),S){b(E,(e=>{}),(e=>{if(e.endsWith(".js")){const t=e.replace(/\.js$/,".ts");c.existsSync(t)?c.unlinkSync(e):c.renameSync(e,t)}else"jsconfig.json"===r.basename(e)&&c.unlinkSync(e)}));const e=r.resolve(E,"index.html"),t=c.readFileSync(e,"utf8");c.writeFileSync(e,t.replace("src/main.js","src/main.ts"))}else b(E,(()=>{}),(e=>{e.endsWith(".ts")&&c.unlinkSync(e)}));s!==E&&console.log(t("cd"),r.relative(s,E)),console.log(n(i(z(U,"install")))),j&&console.log(n(i(z(U,"format")))),console.log(n(i(z(U,"dev")))),console.log()}async function A(s,o,c){const a=v().start();a.start(n(t("Creating a project..."))),j.get(s,{responseType:"arraybuffer"}).then((async t=>{const s=D(c),r=l(s,`${o}-${w}.tgz`);S.writeFileSync(r,t.data),h.extract({file:r,cwd:s,sync:!0}),S.unlinkSync(r),await async function(t,n){try{await S.ensureDir(n),await S.copy(t,n)}catch(t){console.log(e("\n 模板下载过程中可能出现网络错误,请重新尝试")),process.exit(0)}}(l(c,"package/template"),c),function(e="node_modules",t=!0){if(!0===t){const t=v().start();t.start(n("File being deleted..."));try{S.removeSync(D(`${e}`))}catch(e){console.log(e)}t.succeed(n(i("deleted successfully")))}S.removeSync(D(`${e}`))}(l(c,"package"),!1),a.succeed(n(i("Project creation successfully")))})).catch((e=>{console.error("Error:",e)}))}const W=new Map(function(e){const t=new Map;return e.forEach((e=>{t.set(e,`https://registry.npmjs.org/@songyulala/template-${e}/-/template-${e}-2.0.0.tgz`)})),t}(["react-vite","react-webpack"]));(async function(){console.log(`${s("create-stage")}`);const{template:a}=await o({type:"select",name:"template",message:"请选择模板",choices:[{title:"完整模板",value:"full"},{title:"自定义模板",value:"custom"}]});"full"===a?(console.log("full"),async function(){const s=process.cwd(),a=m(process.argv.slice(2),{alias:{force:"f"},string:["_"],boolean:!0});let l=a._[0];const p=l||"new-project",u=a.force||a.f;let f={};try{f=await o([{name:"projectName",type:l?null:"text",message:"Project name:",initial:p,onState:e=>l=String(e.value).trim()||p},{name:"projectType",type:"select",message:"Select features:",hint:"choose the template you want to use",initial:0,choices:[{title:"react-vite",value:"react-vite"},{title:"react-webpack",value:"react-webpack"}]},{name:"managementTool",type:"select",message:"Use management tool?recommend pnpm.",hint:"choose a management tool",initial:0,choices:()=>[{title:"pnpm",value:"pnpm"},{title:"yarn",value:"yarn"},{title:"npm",value:"npm"}]}])}catch(t){console.log(e("\nOperation cancelled.")),process.exit(1)}const y=f.projectName||p,d=f.projectType||"react-vite",S=f.managementTool||"pnpm",h=r.join(s,l);u&&c.existsSync(h)?T(h):c.existsSync(h)||c.mkdirSync(h);const j={name:y,version:w};c.writeFileSync(r.resolve(h,"package.json"),JSON.stringify(j,null,2)),A(W.get(d),d,h);const k=v().start();k.start(n(t("The dependency package is being installed..."))),s!==h&&(console.log(t("cd"),r.relative(s,h)),g("cd "+r.relative(s,h),((e,t,n)=>{e?console.error(e):console.log(t)}))),g(`${S} install`,{cwd:h},((e,t,s)=>{e?console.error(e):(k.succeed(n(i("🚀 Project initialization is complete"))),console.log(t))}))}().catch((e=>{console.error(e)}))):(console.log("custom"),E().catch((e=>{console.error(e)})))})().catch((e=>{console.error(e)}));
