import{red as e,cyan as t,bold as n,green as i,grey as s}from"kleur/colors";import o from"prompts";import*as c from"node:fs";import a,{readFileSync as r}from"node:fs";import*as l from"node:path";import{join as p}from"node:path";import m from"ejs";import u from"minimist";import{pathToFileURL as f}from"node:url";import y from"@songyulala/create-eslint-config";import d from"path";import{fileURLToPath as g}from"url";import{exec as v}from"child_process";import S from"ora";import h from"fs-extra";import j from"tar";import w from"axios";const k="1.0.0",b={active:"yes",inactive:"no"};function x(e,t,n){for(const i of c.readdirSync(e)){if(".git"===i)continue;const s=l.resolve(e,i);c.lstatSync(s).isDirectory()?(t(s),c.existsSync(s)&&x(s,t,n)):n(s)}}function $(e,t,n){for(const i of c.readdirSync(e)){if(".git"===i)continue;const s=l.resolve(e,i);c.lstatSync(s).isDirectory()?($(s,t,n),t(s)):n(s)}}function T(e){c.existsSync(e)&&$(e,(e=>c.rmdirSync(e)),(e=>c.unlinkSync(e)))}function F(e){const t={},n=["dependencies","devDependencies","peerDependencies","optionalDependencies"];for(const i of n)e[i]&&(t[i]={},Object.keys(e[i]).sort().forEach((n=>{t[i][n]=e[i][n]})));return{...e,...t}}const N=e=>e&&"object"==typeof e,O=(e,t)=>Array.from(new Set([...e,...t]));function J(e,t){for(const n of Object.keys(t)){const i=e[n],s=t[n];Array.isArray(i)&&Array.isArray(s)?e[n]=O(i,s):N(i)&&N(s)?e[n]=J(i,s):e[n]=s}return e}function U(e,t,n,i){if(c.statSync(e).isDirectory()){if("node_modules"===l.basename(e))return;c.mkdirSync(t,{recursive:!0});for(const s of c.readdirSync(e))U(l.resolve(e,s),l.resolve(t,s),n,i);return}const s=l.basename(e);if("package.json"===s&&c.existsSync(t)){const n=F(J(JSON.parse(c.readFileSync(t,"utf8")),JSON.parse(c.readFileSync(e,"utf8"))));c.writeFileSync(t,JSON.stringify(n,null,2)+"\n")}else if(s.startsWith("_")&&(t=l.resolve(l.dirname(t),s.replace(/^_/,"."))),"_gitignore"===s&&c.existsSync(t)){const n=c.readFileSync(t,"utf8"),i=c.readFileSync(e,"utf8");c.writeFileSync(t,n+"\n"+i)}else{if(s.endsWith(".data.mjs"))return t=t.replace(/\.data\.mjs$/,""),void n.push((async n=>{const s=(await import(f(e).toString())).default;n[t]=await s({oldData:n[t]||{},deps:JSON.parse(i)})}));c.copyFileSync(e,t)}}const P=g(import.meta.url),_=d.dirname(P),D=a.realpathSync(process.cwd());function z(e){return d.resolve(D,e)}function E(e,t,n){return"install"===t?"yarn"===e?"yarn":`${e} install`:n?"npm"===e?`npm run ${t} -- ${n}`:`${e} ${t} ${n}`:"npm"===e?`npm run ${t}`:`${e} ${t}`}async function A(){const s=process.cwd(),a=u(process.argv.slice(2),{alias:{force:"f",help:"h",version:"v",ts:"typescript",eslint:"e",prettier:"p",husky:"h","lint-staged":"ls","unit-testing":"ut",jest:"j",vitest:"v"},string:["_"],boolean:!0});let r=a._[0];const p=r||"new-project",f=a.force||a.f,d="boolean"==typeof(a.ts||a.typescript||a.eslint||a.prettier||a.husky||a["lint-staged"]||a["unit-testing"]||a.jest||a.vitest);let g={};try{g=await o([{name:"projectName",type:r?null:"text",message:"Project name:",initial:p,onState:e=>r=String(e.value).trim()||p},{name:"needsTypeScript",type:()=>d?null:"toggle",message:"Use TypeScript?",initial:b.inactive,active:b.active,inactive:b.inactive},{name:"needsEslint",type:()=>d?null:"toggle",message:"Use ESLint?",initial:b.inactive,active:b.active,inactive:b.inactive},{name:"needsPrettier",type:()=>d?null:"toggle",message:"Use Prettier?",initial:b.inactive,active:b.active,inactive:b.inactive},{name:"needsHusky",message:"Use Husky?",type:()=>d?null:"toggle",initial:b.inactive,active:b.active,inactive:b.inactive},{name:"needsLintStaged",type:()=>d?null:"toggle",message:"Use lint-staged?",initial:b.inactive,active:b.active,inactive:b.inactive},{name:"needsUnitTesting",type:()=>d?null:"select",message:"Use unit testing?",hint:"choose a testing framework",initial:0,choices:()=>[{title:"No",value:!1},{title:"Jest",value:"Jest"},{title:"Vitest",value:"Vitest"}]},{name:"managementTool",type:()=>d?null:"select",message:"Use management tool?recommend pnpm.",hint:"choose a management tool",initial:0,choices:()=>[{title:"pnpm",value:"pnpm"},{title:"yarn",value:"yarn"},{title:"npm",value:"npm"}]},{name:"buildTool",type:()=>d?null:"select",message:"Use build tool?recommend vite.",hint:"choose a build tool",initial:0,choices:()=>[{title:"vite",value:"vite"},{title:"webpack",value:"webpack"},{title:"rollup",value:"rollup"}]},{name:"atomizationcss",type:()=>d?null:"select",message:"Use atomization css?",hint:"choose a atomization css",initial:0,choices:()=>[{title:"No",value:!1},{title:"tailwindcss",value:"tailwindcss"},{title:"windicss",value:"windicss"},{title:"unocss",value:"unocss"}]}])}catch(t){console.log(e("\nOperation cancelled.")),process.exit(1)}const v=g.projectName||p,S=a.ts||a.typescript||g.needsTypeScript,h=a.eslint||g.needsEslint,j=a.prettier||g.needsPrettier;a.husky||g.needsHusky,a["lint-staged"]||g.needsLintStaged;const w=a["unit-testing"]||g.needsUnitTesting,$=a.jest||g.needsJest,N=a.vitest||g.needsVitest,O=g.managementTool||"pnpm",P=g.buildTool||"vite",D=g.atomizationcss||!1,z=l.join(s,r);f&&c.existsSync(z)?T(z):c.existsSync(z)||c.mkdirSync(z);const A={name:v,version:k};c.writeFileSync(l.resolve(z,"package.json"),JSON.stringify(A,null,2));const W=l.resolve(_,"templates"),H=[],L=function(e){U(l.resolve(W,e),z,H,JSON.stringify(g))};if(L("base"),S){L("config/typescript"),L("tsconfig/base");const e={files:[],references:[{path:"./tsconfig.node.json"},{path:"./tsconfig.app.json"}]};$&&(L("tsconfig/jest"),e.references.push({path:"./tsconfig.jest.json"})),N&&(L("tsconfig/vitest"),e.references.push({path:"./tsconfig.vitest.json"})),c.writeFileSync(l.resolve(z,"tsconfig.json"),JSON.stringify(e,null,2)+"\n","utf-8")}if(h&&function(e,{needsTypeScript:t,needsPrettier:n}){const{pkg:i,files:s}=y({styleGuide:"default",hasTypeScript:t,needsPrettier:n,additionalConfig:{},additionalDependencies:{}}),o={lint:t?"eslint . --ext .js,.jsx,.cjs,.mjs,.ts,.tsx,.cts,.mts --fix --ignore-path .gitignore":"eslint . --ext .js,.jsx,.cjs,.mjs --fix --ignore-path .gitignore"};n&&(o.format="prettier --write src/");const a=l.resolve(e,"package.json"),r=F(J(J(JSON.parse(c.readFileSync(a,"utf8")),i),{scripts:o}));c.writeFileSync(a,JSON.stringify(r,null,2)+"\n","utf-8");for(const[t,n]of Object.entries(s)){const i=l.resolve(e,t);c.writeFileSync(i,n,"utf-8")}}(z,{needsTypeScript:S,needsPrettier:j}),w&&($?L("config/jest"):N&&L("config/vitest")),D)switch(D){case"tailwindcss":L("config/tailwindcss"),L("entry/tailwindcss");break;case"windicss":L("config/windicss"),L("windicss/base");break;case"unocss":L("config/unocss"),L("unocss")}switch(L("entry/default"),L("code/router"),P){case"vite":L("config/vite"),L("vite");break;case"webpack":L("config/webpack"),L("webpack/base");break;case"rollup":L("config/rollup"),L("rollup")}const V={};for(const e of H)await e(V);if(x(z,(()=>{}),(e=>{if(e.endsWith(".ejs")){const t=c.readFileSync(e,"utf-8"),n=e.replace(/\.ejs$/,"");let i="";i=n.includes("html")?m.render(t,{title:v,buildTool:P,needsTypeScript:S}):m.render(t,V[n]),c.writeFileSync(n,i),c.unlinkSync(e)}})),S){x(z,(e=>{}),(e=>{if(e.endsWith(".js")){const t=e.replace(/\.js$/,".ts");c.existsSync(t)?c.unlinkSync(e):c.renameSync(e,t)}else"jsconfig.json"===l.basename(e)&&c.unlinkSync(e)}));const e=l.resolve(z,"index.html"),t=c.readFileSync(e,"utf8");c.writeFileSync(e,t.replace("src/main.js","src/main.ts"))}else x(z,(()=>{}),(e=>{e.endsWith(".ts")&&c.unlinkSync(e)}));s!==z&&console.log(t("cd"),l.relative(s,z)),console.log(n(i(E(O,"install")))),j&&console.log(n(i(E(O,"format")))),console.log(n(i(E(O,"dev")))),console.log()}function W(e){var t,n;return t=`../template-config/${e}.json`,n=!0,JSON.parse(r(n?p(_,t):t).toString())}async function H(s,o,c,a){const r=S().start();r.start(n(t("Creating a project..."))),w.get(s,{responseType:"arraybuffer"}).then((async t=>{const s=z(c),l=p(s,`${o}-${k}.tgz`);h.writeFileSync(l,t.data),j.extract({file:l,cwd:s,sync:!0}),h.unlinkSync(l),await async function(t,n){try{await h.ensureDir(n),await h.copy(t,n)}catch(t){console.log(e("\n 模板下载过程中可能出现网络错误,请重新尝试")),process.exit(0)}}(p(c,"package/template"),c);const m=await h.readJsonSync(p(c,"package/package.json"));a&&a(m),function(e="node_modules",t=!0){if(!0===t){const t=S().start();t.start(n("File being deleted..."));try{h.removeSync(z(`${e}`))}catch(e){console.log(e)}t.succeed(n(i("deleted successfully")))}h.removeSync(z(`${e}`))}(p(c,"package"),!1),r.succeed(n(i("Project creation successfully")))})).catch((e=>{console.error("Error:",e)}))}const L=new Map(function(e){const t=new Map;return e.forEach((e=>{t.set(e,`https://registry.npmjs.org/@songyulala/template-${e}/-/template-${e}-2.0.0.tgz`)})),t}(["react-vite","react-webpack"]));(async function(){console.log(`${s("create-stage")}`);const{template:a}=await o({type:"select",name:"template",message:"请选择模板",choices:[{title:"完整模板",value:"full"},{title:"自定义模板",value:"custom"}]});"full"===a?(console.log("full"),async function(){const s=process.cwd(),a=u(process.argv.slice(2),{alias:{force:"f"},string:["_"],boolean:!0});let r=a._[0];const p=r||"new-project",m=a.force||a.f;let f={};try{f=await o([{name:"projectName",type:r?null:"text",message:"Project name:",initial:p,onState:e=>r=String(e.value).trim()||p},{name:"projectType",type:"select",message:"Select features:",hint:"choose the template you want to use",initial:0,choices:[{title:"react-vite",value:"react-vite"},{title:"react-webpack",value:"react-webpack"}]},{name:"managementTool",type:"select",message:"Use management tool?recommend pnpm.",hint:"choose a management tool",initial:0,choices:()=>[{title:"pnpm",value:"pnpm"},{title:"yarn",value:"yarn"},{title:"npm",value:"npm"}]}])}catch(t){console.log(e("\nOperation cancelled.")),process.exit(1)}const y=f.projectName||p,d=f.projectType||"react-vite",g=f.managementTool||"pnpm",h=l.join(s,r);m&&c.existsSync(h)?T(h):c.existsSync(h)||c.mkdirSync(h);const j=W(d),w={name:y,version:k,...j},b=l.resolve(h,"package.json");await c.writeFileSync(b,JSON.stringify(w,null,2)+"\n","utf-8"),await H(L.get(d),d,h);const x=S().start();x.start(n(t("The dependency package is being installed..."))),s!==h&&(console.log(t("cd"),l.relative(s,h)),v("cd "+l.relative(s,h),((e,t,n)=>{e&&console.error(e)}))),v(`${g} install`,{cwd:h},((e,t,s)=>{e?console.error(e):(x.succeed(n(i("🚀 Project initialization is complete"))),console.log(t))}))}().catch((e=>{console.error(e)}))):(console.log("custom"),A().catch((e=>{console.error(e)})))})().catch((e=>{console.error(e)}));
