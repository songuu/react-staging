#!/usr/bin/env node
import*as e from"node:fs";import t from"node:fs";import*as n from"node:path";import s from"ejs";import i from"minimist";import o from"prompts";import{grey as c,red as r,cyan as a,bold as l,green as p}from"kleur/colors";import{pathToFileURL as f}from"node:url";import u from"create-eslint-config";import m from"path";import{fileURLToPath as d}from"url";const y="yes",g="no";function S(t,s,i){for(const o of e.readdirSync(t)){if(".git"===o)continue;const c=n.resolve(t,o);e.lstatSync(c).isDirectory()?(s(c),e.existsSync(c)&&S(c,s,i)):i(c)}}function v(t,s,i){for(const o of e.readdirSync(t)){if(".git"===o)continue;const c=n.resolve(t,o);e.lstatSync(c).isDirectory()?(v(c,s,i),s(c)):i(c)}}function h(e){const t={},n=["dependencies","devDependencies","peerDependencies","optionalDependencies"];for(const s of n)e[s]&&(t[s]={},Object.keys(e[s]).sort().forEach((n=>{t[s][n]=e[s][n]})));return{...e,...t}}const j=e=>e&&"object"==typeof e,w=(e,t)=>Array.from(new Set([...e,...t]));function k(e,t){for(const n of Object.keys(t)){const s=e[n],i=t[n];Array.isArray(s)&&Array.isArray(i)?e[n]=w(s,i):j(s)&&j(i)?e[n]=k(s,i):e[n]=i}return e}function b(t,s,i,o){if(e.statSync(t).isDirectory()){if("node_modules"===n.basename(t))return;e.mkdirSync(s,{recursive:!0});for(const c of e.readdirSync(t))b(n.resolve(t,c),n.resolve(s,c),i,o);return}const c=n.basename(t);if("package.json"===c&&e.existsSync(s)){const n=h(k(JSON.parse(e.readFileSync(s,"utf8")),JSON.parse(e.readFileSync(t,"utf8"))));e.writeFileSync(s,JSON.stringify(n,null,2)+"\n")}else if(c.startsWith("_")&&(s=n.resolve(n.dirname(s),c.replace(/^_/,"."))),"_gitignore"===c&&e.existsSync(s)){const n=e.readFileSync(s,"utf8"),i=e.readFileSync(t,"utf8");e.writeFileSync(s,n+"\n"+i)}else{if(c.endsWith(".data.mjs"))return s=s.replace(/\.data\.mjs$/,""),void i.push((async e=>{const n=(await import(f(t).toString())).default;e[s]=await n({oldData:e[s]||{},deps:JSON.parse(o)})}));e.copyFileSync(t,s)}}const x=d(import.meta.url),F=m.dirname(x);function T(e,t,n){return"install"===t?"yarn"===e?"yarn":`${e} install`:n?"npm"===e?`npm run ${t} -- ${n}`:`${e} ${t} ${n}`:"npm"===e?`npm run ${t}`:`${e} ${t}`}function N(t){e.existsSync(t)&&v(t,(t=>e.rmdirSync(t)),(t=>e.unlinkSync(t)))}t.realpathSync(process.cwd()),async function(){console.log(`${c("create-staging")}`);const t=process.cwd(),f=i(process.argv.slice(2),{alias:{force:"f",help:"h",version:"v",ts:"typescript",eslint:"e",prettier:"p",husky:"h","lint-staged":"ls","unit-testing":"ut",jest:"j",vitest:"v"},string:["_"],boolean:!0});let m=f._[0];const d=m||"new-project",v=f.force||f.f,j="boolean"==typeof(f.ts||f.typescript||f.eslint||f.prettier||f.husky||f["lint-staged"]||f["unit-testing"]||f.jest||f.vitest);let w={};try{w=await o([{name:"projectName",type:m?null:"text",message:"Project name:",initial:d,onState:e=>m=String(e.value).trim()||d},{name:"needsTypeScript",type:()=>j?null:"toggle",message:"Use TypeScript?",initial:g,active:y,inactive:g},{name:"needsEslint",type:()=>j?null:"toggle",message:"Use ESLint?",initial:g,active:y,inactive:g},{name:"needsPrettier",type:()=>j?null:"toggle",message:"Use Prettier?",initial:g,active:y,inactive:g},{name:"needsHusky",message:"Use Husky?",type:()=>j?null:"toggle",initial:g,active:y,inactive:g},{name:"needsLintStaged",type:()=>j?null:"toggle",message:"Use lint-staged?",initial:g,active:y,inactive:g},{name:"needsUnitTesting",type:()=>j?null:"select",message:"Use unit testing?",hint:"choose a testing framework",initial:0,choices:()=>[{title:"No",value:!1},{title:"Jest",value:"Jest"},{title:"Vitest",value:"Vitest"}]},{name:"managementTool",type:()=>j?null:"select",message:"Use management tool?recommend pnpm.",hint:"choose a management tool",initial:0,choices:()=>[{title:"pnpm",value:"pnpm"},{title:"yarn",value:"yarn"},{title:"npm",value:"npm"}]},{name:"buildTool",type:()=>j?null:"select",message:"Use build tool?recommend vite.",hint:"choose a build tool",initial:0,choices:()=>[{title:"vite",value:"vite"},{title:"webpack",value:"webpack"},{title:"rollup",value:"rollup"}]},{name:"atomizationcss",type:()=>j?null:"select",message:"Use atomization css?",hint:"choose a atomization css",initial:0,choices:()=>[{title:"No",value:!1},{title:"tailwindcss",value:"tailwindcss"},{title:"windicss",value:"windicss"},{title:"unocss",value:"unocss"}]}])}catch(e){console.log(r("\nOperation cancelled.")),process.exit(1)}const x=w.projectName||d,O=f.ts||f.typescript||w.needsTypeScript,$=f.eslint||w.needsEslint,J=f.prettier||w.needsPrettier;f.husky||w.needsHusky,f["lint-staged"]||w.needsLintStaged;const U=f["unit-testing"]||w.needsUnitTesting,D=f.jest||w.needsJest,P=f.vitest||w.needsVitest,_=w.managementTool||"pnpm",A=w.buildTool||"vite",W=w.atomizationcss||!1,z=n.join(t,m);v&&e.existsSync(z)?N(z):e.existsSync(z)||e.mkdirSync(z);const E={name:x,version:"1.0.0"};e.writeFileSync(n.resolve(z,"package.json"),JSON.stringify(E,null,2));const H=n.resolve(F,"templates"),L=[],V=function(e){b(n.resolve(H,e),z,L,JSON.stringify(w))};if(V("base"),O){V("config/typescript"),V("tsconfig/base");const t={files:[],references:[{path:"./tsconfig.node.json"},{path:"./tsconfig.app.json"}]};D&&(V("tsconfig/jest"),t.references.push({path:"./tsconfig.jest.json"})),P&&(V("tsconfig/vitest"),t.references.push({path:"./tsconfig.vitest.json"})),e.writeFileSync(n.resolve(z,"tsconfig.json"),JSON.stringify(t,null,2)+"\n","utf-8")}if($&&function(t,{needsTypeScript:s,needsPrettier:i}){const{pkg:o,files:c}=u({styleGuide:"default",hasTypeScript:s,needsPrettier:i,additionalConfig:{},additionalDependencies:{}}),r={lint:s?"eslint . --ext .js,.jsx,.cjs,.mjs,.ts,.tsx,.cts,.mts --fix --ignore-path .gitignore":"eslint . --ext .js,.jsx,.cjs,.mjs --fix --ignore-path .gitignore"};i&&(r.format="prettier --write src/");const a=n.resolve(t,"package.json"),l=h(k(k(JSON.parse(e.readFileSync(a,"utf8")),o),{scripts:r}));e.writeFileSync(a,JSON.stringify(l,null,2)+"\n","utf-8");for(const[s,i]of Object.entries(c)){const o=n.resolve(t,s);e.writeFileSync(o,i,"utf-8")}}(z,{needsTypeScript:O,needsPrettier:J}),U&&(D?V("config/jest"):P&&V("config/vitest")),W)switch(W){case"tailwindcss":V("config/tailwindcss"),V("entry/tailwindcss");break;case"windicss":V("config/windicss"),V("windicss/base");break;case"unocss":V("config/unocss"),V("unocss")}switch(V("entry/default"),V("code/router"),A){case"vite":V("config/vite"),V("vite");break;case"webpack":V("config/webpack"),V("webpack/base");break;case"rollup":V("config/rollup"),V("rollup")}const C={};for(const e of L)await e(C);if(S(z,(()=>{}),(t=>{if(t.endsWith(".ejs")){const n=e.readFileSync(t,"utf-8"),i=t.replace(/\.ejs$/,"");let o="";o=i.includes("html")?s.render(n,{title:x,buildTool:A,needsTypeScript:O}):s.render(n,C[i]),e.writeFileSync(i,o),e.unlinkSync(t)}})),O){S(z,(e=>{}),(t=>{if(t.endsWith(".js")){const n=t.replace(/\.js$/,".ts");e.existsSync(n)?e.unlinkSync(t):e.renameSync(t,n)}else"jsconfig.json"===n.basename(t)&&e.unlinkSync(t)}));const t=n.resolve(z,"index.html"),s=e.readFileSync(t,"utf8");e.writeFileSync(t,s.replace("src/main.js","src/main.ts"))}else S(z,(()=>{}),(t=>{t.endsWith(".ts")&&e.unlinkSync(t)}));t!==z&&console.log(a("cd"),n.relative(t,z)),console.log(l(p(T(_,"install")))),J&&console.log(l(p(T(_,"format")))),console.log(l(p(T(_,"dev")))),console.log()}().catch((e=>{console.error(e)}));
