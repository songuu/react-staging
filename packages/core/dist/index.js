import{red as e,cyan as t,bold as n,green as s,grey as i}from"kleur/colors";import c from"prompts";import*as o from"node:fs";import a from"node:fs";import*as r from"node:path";import{join as l}from"node:path";import p from"ejs";import m from"minimist";import{pathToFileURL as u}from"node:url";import f from"@songyulala/create-eslint-config";import y from"path";import{fileURLToPath as d}from"url";import{exec as g}from"child_process";import v from"ora";import S from"fs-extra";import h from"tar";import j from"axios";const w="1.0.0",k={active:"yes",inactive:"no"};function b(e,t,n){for(const s of o.readdirSync(e)){if(".git"===s)continue;const i=r.resolve(e,s);o.lstatSync(i).isDirectory()?(t(i),o.existsSync(i)&&b(i,t,n)):n(i)}}function x(e,t,n){for(const s of o.readdirSync(e)){if(".git"===s)continue;const i=r.resolve(e,s);o.lstatSync(i).isDirectory()?(x(i,t,n),t(i)):n(i)}}function T(e){o.existsSync(e)&&x(e,(e=>o.rmdirSync(e)),(e=>o.unlinkSync(e)))}function F(e){const t={},n=["dependencies","devDependencies","peerDependencies","optionalDependencies"];for(const s of n)e[s]&&(t[s]={},Object.keys(e[s]).sort().forEach((n=>{t[s][n]=e[s][n]})));return{...e,...t}}const $=e=>e&&"object"==typeof e,N=(e,t)=>Array.from(new Set([...e,...t]));function O(e,t){for(const n of Object.keys(t)){const s=e[n],i=t[n];Array.isArray(s)&&Array.isArray(i)?e[n]=N(s,i):$(s)&&$(i)?e[n]=O(s,i):e[n]=i}return e}function J(e,t,n,s){if(o.statSync(e).isDirectory()){if("node_modules"===r.basename(e))return;o.mkdirSync(t,{recursive:!0});for(const i of o.readdirSync(e))J(r.resolve(e,i),r.resolve(t,i),n,s);return}const i=r.basename(e);if("package.json"===i&&o.existsSync(t)){const n=F(O(JSON.parse(o.readFileSync(t,"utf8")),JSON.parse(o.readFileSync(e,"utf8"))));o.writeFileSync(t,JSON.stringify(n,null,2)+"\n")}else if(i.startsWith("_")&&(t=r.resolve(r.dirname(t),i.replace(/^_/,"."))),"_gitignore"===i&&o.existsSync(t)){const n=o.readFileSync(t,"utf8"),s=o.readFileSync(e,"utf8");o.writeFileSync(t,n+"\n"+s)}else{if(i.endsWith(".data.mjs"))return t=t.replace(/\.data\.mjs$/,""),void n.push((async n=>{const i=(await import(u(e).toString())).default;n[t]=await i({oldData:n[t]||{},deps:JSON.parse(s)})}));o.copyFileSync(e,t)}}const U=d(import.meta.url),D=y.dirname(U),_=a.realpathSync(process.cwd());function P(e){return y.resolve(_,e)}function z(e,t,n){return"install"===t?"yarn"===e?"yarn":`${e} install`:n?"npm"===e?`npm run ${t} -- ${n}`:`${e} ${t} ${n}`:"npm"===e?`npm run ${t}`:`${e} ${t}`}async function E(){const i=process.cwd(),a=m(process.argv.slice(2),{alias:{force:"f",help:"h",version:"v",ts:"typescript",eslint:"e",prettier:"p",husky:"h","lint-staged":"ls","unit-testing":"ut",jest:"j",vitest:"v"},string:["_"],boolean:!0});let l=a._[0];const u=l||"new-project",y=a.force||a.f,d="boolean"==typeof(a.ts||a.typescript||a.eslint||a.prettier||a.husky||a["lint-staged"]||a["unit-testing"]||a.jest||a.vitest);let g={};try{g=await c([{name:"projectName",type:l?null:"text",message:"Project name:",initial:u,onState:e=>l=String(e.value).trim()||u},{name:"needsTypeScript",type:()=>d?null:"toggle",message:"Use TypeScript?",initial:k.inactive,active:k.active,inactive:k.inactive},{name:"needsEslint",type:()=>d?null:"toggle",message:"Use ESLint?",initial:k.inactive,active:k.active,inactive:k.inactive},{name:"needsPrettier",type:()=>d?null:"toggle",message:"Use Prettier?",initial:k.inactive,active:k.active,inactive:k.inactive},{name:"needsHusky",message:"Use Husky?",type:()=>d?null:"toggle",initial:k.inactive,active:k.active,inactive:k.inactive},{name:"needsLintStaged",type:()=>d?null:"toggle",message:"Use lint-staged?",initial:k.inactive,active:k.active,inactive:k.inactive},{name:"needsUnitTesting",type:()=>d?null:"select",message:"Use unit testing?",hint:"choose a testing framework",initial:0,choices:()=>[{title:"No",value:!1},{title:"Jest",value:"Jest"},{title:"Vitest",value:"Vitest"}]},{name:"managementTool",type:()=>d?null:"select",message:"Use management tool?recommend pnpm.",hint:"choose a management tool",initial:0,choices:()=>[{title:"pnpm",value:"pnpm"},{title:"yarn",value:"yarn"},{title:"npm",value:"npm"}]},{name:"buildTool",type:()=>d?null:"select",message:"Use build tool?recommend vite.",hint:"choose a build tool",initial:0,choices:()=>[{title:"vite",value:"vite"},{title:"webpack",value:"webpack"},{title:"rollup",value:"rollup"}]},{name:"atomizationcss",type:()=>d?null:"select",message:"Use atomization css?",hint:"choose a atomization css",initial:0,choices:()=>[{title:"No",value:!1},{title:"tailwindcss",value:"tailwindcss"},{title:"windicss",value:"windicss"},{title:"unocss",value:"unocss"}]}])}catch(t){console.log(e("\nOperation cancelled.")),process.exit(1)}const v=g.projectName||u,S=a.ts||a.typescript||g.needsTypeScript,h=a.eslint||g.needsEslint,j=a.prettier||g.needsPrettier;a.husky||g.needsHusky,a["lint-staged"]||g.needsLintStaged;const x=a["unit-testing"]||g.needsUnitTesting,$=a.jest||g.needsJest,N=a.vitest||g.needsVitest,U=g.managementTool||"pnpm",_=g.buildTool||"vite",P=g.atomizationcss||!1,E=r.join(i,l);y&&o.existsSync(E)?T(E):o.existsSync(E)||o.mkdirSync(E);const A={name:v,version:w};o.writeFileSync(r.resolve(E,"package.json"),JSON.stringify(A,null,2));const W=r.resolve(D,"templates"),H=[],L=function(e){J(r.resolve(W,e),E,H,JSON.stringify(g))};if(L("base"),S){L("config/typescript"),L("tsconfig/base");const e={files:[],references:[{path:"./tsconfig.node.json"},{path:"./tsconfig.app.json"}]};$&&(L("tsconfig/jest"),e.references.push({path:"./tsconfig.jest.json"})),N&&(L("tsconfig/vitest"),e.references.push({path:"./tsconfig.vitest.json"})),o.writeFileSync(r.resolve(E,"tsconfig.json"),JSON.stringify(e,null,2)+"\n","utf-8")}if(h&&function(e,{needsTypeScript:t,needsPrettier:n}){const{pkg:s,files:i}=f({styleGuide:"default",hasTypeScript:t,needsPrettier:n,additionalConfig:{},additionalDependencies:{}}),c={lint:t?"eslint . --ext .js,.jsx,.cjs,.mjs,.ts,.tsx,.cts,.mts --fix --ignore-path .gitignore":"eslint . --ext .js,.jsx,.cjs,.mjs --fix --ignore-path .gitignore"};n&&(c.format="prettier --write src/");const a=r.resolve(e,"package.json"),l=F(O(O(JSON.parse(o.readFileSync(a,"utf8")),s),{scripts:c}));o.writeFileSync(a,JSON.stringify(l,null,2)+"\n","utf-8");for(const[t,n]of Object.entries(i)){const s=r.resolve(e,t);o.writeFileSync(s,n,"utf-8")}}(E,{needsTypeScript:S,needsPrettier:j}),x&&($?L("config/jest"):N&&L("config/vitest")),P)switch(P){case"tailwindcss":L("config/tailwindcss"),L("entry/tailwindcss");break;case"windicss":L("config/windicss"),L("windicss/base");break;case"unocss":L("config/unocss"),L("unocss")}switch(L("entry/default"),L("code/router"),_){case"vite":L("config/vite"),L("vite");break;case"webpack":L("config/webpack"),L("webpack/base");break;case"rollup":L("config/rollup"),L("rollup")}const V={};for(const e of H)await e(V);if(b(E,(()=>{}),(e=>{if(e.endsWith(".ejs")){const t=o.readFileSync(e,"utf-8"),n=e.replace(/\.ejs$/,"");let s="";s=n.includes("html")?p.render(t,{title:v,buildTool:_,needsTypeScript:S}):p.render(t,V[n]),o.writeFileSync(n,s),o.unlinkSync(e)}})),S){b(E,(e=>{}),(e=>{if(e.endsWith(".js")){const t=e.replace(/\.js$/,".ts");o.existsSync(t)?o.unlinkSync(e):o.renameSync(e,t)}else"jsconfig.json"===r.basename(e)&&o.unlinkSync(e)}));const e=r.resolve(E,"index.html"),t=o.readFileSync(e,"utf8");o.writeFileSync(e,t.replace("src/main.js","src/main.ts"))}else b(E,(()=>{}),(e=>{e.endsWith(".ts")&&o.unlinkSync(e)}));i!==E&&console.log(t("cd"),r.relative(i,E)),console.log(n(s(z(U,"install")))),j&&console.log(n(s(z(U,"format")))),console.log(n(s(z(U,"dev")))),console.log()}async function A(i,c,o,a){const r=v().start();r.start(n(t("Creating a project..."))),j.get(i,{responseType:"arraybuffer"}).then((async t=>{const i=P(o),p=l(i,`${c}-${w}.tgz`);S.writeFileSync(p,t.data),h.extract({file:p,cwd:i,sync:!0}),S.unlinkSync(p),await async function(t,n){try{await S.ensureDir(n),await S.copy(t,n)}catch(t){console.log(e("\n 模板下载过程中可能出现网络错误,请重新尝试")),process.exit(0)}}(l(o,"package/template"),o);const m=await S.readJsonSync(l(o,"package/package.json"));a&&a(m),function(e="node_modules",t=!0){if(!0===t){const t=v().start();t.start(n("File being deleted..."));try{S.removeSync(P(`${e}`))}catch(e){console.log(e)}t.succeed(n(s("deleted successfully")))}S.removeSync(P(`${e}`))}(l(o,"package"),!1),r.succeed(n(s("Project creation successfully")))})).catch((e=>{console.error("Error:",e)}))}const W=new Map(function(e){const t=new Map;return e.forEach((e=>{t.set(e,`https://registry.npmjs.org/@songyulala/template-${e}/-/template-${e}-2.0.0.tgz`)})),t}(["react-vite","react-webpack"]));(async function(){console.log(`${i("create-stage")}`);const{template:s}=await c({type:"select",name:"template",message:"请选择模板",choices:[{title:"完整模板",value:"full"},{title:"自定义模板",value:"custom"}]});"full"===s?(console.log("full"),async function(){const s=process.cwd(),i=m(process.argv.slice(2),{alias:{force:"f"},string:["_"],boolean:!0});let a=i._[0];const l=a||"new-project",p=i.force||i.f;let u={};try{u=await c([{name:"projectName",type:a?null:"text",message:"Project name:",initial:l,onState:e=>a=String(e.value).trim()||l},{name:"projectType",type:"select",message:"Select features:",hint:"choose the template you want to use",initial:0,choices:[{title:"react-vite",value:"react-vite"},{title:"react-webpack",value:"react-webpack"}]},{name:"managementTool",type:"select",message:"Use management tool?recommend pnpm.",hint:"choose a management tool",initial:0,choices:()=>[{title:"pnpm",value:"pnpm"},{title:"yarn",value:"yarn"},{title:"npm",value:"npm"}]}])}catch(t){console.log(e("\nOperation cancelled.")),process.exit(1)}const f=u.projectName||l,y=u.projectType||"react-vite";u.managementTool;const d=r.join(s,a);p&&o.existsSync(d)?T(d):o.existsSync(d)||o.mkdirSync(d),await A(W.get(y),y,d,(async e=>{const{devDependencies:t={},dependencies:n={},scripts:s={}}=e,i={name:f,version:w,scripts:s,devDependencies:t,dependencies:n},c=r.resolve(d,"package.json");await o.writeFileSync(c,JSON.stringify(i,null,2)+"\n","utf-8")})),v().start().start(n(t("The dependency package is being installed..."))),s!==d&&(console.log(t("cd"),r.relative(s,d)),g("cd "+r.relative(s,d),((e,t,n)=>{e?console.error(e):console.log(t)})))}().catch((e=>{console.error(e)}))):(console.log("custom"),E().catch((e=>{console.error(e)})))})().catch((e=>{console.error(e)}));
